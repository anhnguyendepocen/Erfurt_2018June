---
title: "Data wrangling with dplyr"
author: "BaselRBootcamp"
output: html_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(comment=NA, fig.width=6, fig.height=6, echo = FALSE, eval = FALSE, warning = FALSE)
```

```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "70%"}
knitr::include_graphics("../_image/dplyr_functions.png")
```

### Slides

- [Here are the introduction slides for this practical on data wrangling!](https://therbootcamp.github.io/BaselRBootcamp_2018April/_sessions/D2S1_Wrangling/Wrangling.html#1)

### Overview

In this practical you'll practice "data wrangling" with the `dplyr` package (part of the `tidyverse collection of packages). Data wrangling refers to modifying and summarizing data. For example, sorting, adding columns, recoding values, and calculating summary statistics. 

By the end of this practical you will know how to:

1. Change column names, select specific columns.
2. Create new columns based on existing ones
3. Select specific rows of data based on multiple criteria.
4. Group data and calculate summary statistics
5. Combine multiple datasets through key columns

### Cheatsheet

- Data wrangling with dplyr Cheatsheet: [https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf).

### Glossary

Here are the main functions you will be using in `dplyr`:

| verb| action| example |
|:---|:----------------------|:--------------------------------------|
|     `filter()`|    Select rows based on some criteria| data %>% filter(age > 40 & sex == "m")|
|     `arrange()`|    Sort rows| data %>% arrange(date, group)|
|     `select()`|    Select columns.| data %>% select(age, sex)<br>data %>% select(age, sex, everything())|
|     `rename()`|    Rename columns| data %>% rename(new = old)|
|     `mutate()`|    Add new columns| data %>% mutate(height.m = height.cm / 100)|
|     `case_when()`|    Recode values of a column| data %>% mutate(sex_n = case_when(sex == 0 ~ "m", sex == 1 ~ "f"))|
|     `group_by(), summarise()`|   Group data and then calculate summary statistics|data %>% group_by(...) %>% summarise(...)|
|     `left_join()`|   Combine multiple datasets using a key column|data %>% left_join(data2, by = "id")|

Here are the two functions you will be using from the `tidyr` paxakge:

| verb| action| example |
|:---|:----------------------|:--------------------------------------|
|     `spread()`|    Convert long data to wide format - from rows to columns|
|     `gather()`|    Convert wide datq to long format - from columns to rows|

### Examples

- The following examples will take you through the steps of doing data wrangling with dplyr. Try to go through each line of code and see how it works!

```{r, eval = FALSE, echo = TRUE}
# -----------------------------------------------
# Examples of using dplyr on the baselers data
# ------------------------------------------------

library(tidyverse)         # Load tidyverse for dplyr

# Laod baselers data
baselers <- read_csv("https://raw.githubusercontent.com/therbootcamp/baselers/master/inst/extdata/baselers.txt")

baselers <- baselers %>%
  
  # Change some names
  rename(age_y = age,
         swimming = rhine) %>%
  
  # Only include people over 30
  filter(age_y > 30) %>%
  
  # Calculate some new columns
  mutate(weight_lbs = weight * 2.22,
         height_m = height / 100,
         BMI = weight / height_m ^ 2,
         
         # Make binary version of sex
         sex_bin = case_when(
                      sex == "male" ~ 0,
                      sex == "female" ~ 1,
                      TRUE ~ NA_real_)),

        # Show when height is greater than 150
        height_lt_150 = case_when(
          height < 150 ~ 1,
          height >= 150 ~ 0,
          TRUE ~ NA_real_
        ) %>%
  
  # Sort in ascending order of sex, then
  #  descending order of age
  arrange(sex, desc(age_y))


# Calculate grouped summary statistics

baselers_agg <- baselers %>%
  group_by(sex, education) %>%
  summarise(
    age_mean = mean(age_y, na.rm = TRUE),
    income_median = median(income, na.rm = TRUE),
    N = n()
  )
```


## Tasks

### Datasets

You'll use one dataset in this practical: `ACTG175.csv`. It is available in the `data_BaselRBootcamp_Day2.zip` file available through the main course page. If you haven't already, download the `data_BaselRBootcamp_Day2.zip` folder and unzip it to get the `ACTG175.csv` file.

### Getting setup

A. Open your R project. It should alreaduy have the folders `data` and `R`. Make sure that the `ACTG175.csv` is in the `data` folder

```{r}
# Done!
```

B. Open a new R script and save it as a new file called `wrangling_practical.R` in the `R` folder in your working directory. At the top of the script, using comments, write your name and the date. The, load the set of `tidyverse` and `speff2trial` packages with `library()`. Here's how the top of your script should look:

```{r, eval = FALSE, echo = TRUE}
## NAME
## DATE
## Wrangling Practical

library(tidyverse)     # For tidyverse
library(speff2trial)   # For the ACTG175 data documentation
```

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE}
library(tidyverse)
library(speff2trial)
```

C. For this practical, we'll use the `ACTG175` data, this is the result of a randomized clinical trial comparing the effects of different medications on adults infected with the human immunodeficiency virus. Using the following template, load the data into R and store it as a new object called `trial_act`.

```{r, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
# Load ACTG175.csv from the data folder in your working directory

trial_act <- read_csv(file = "data/ACTG175.csv")
```

```{r, echo = FALSE, eval = FALSE, message = FALSE, warning = FALSE}
trial_act <- read_csv(file = "https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp2017/master/tutorials/data/ACTG175.csv")
```

```{r, message = FALSE, echo = FALSE, eval = TRUE, warning = FALSE}
library(tidyverse)
```

D. The `trial_act` data is actually a copy of a dataset from the `speff2trial` package called `ACTG175`. We can make Look at the help menu for the `ACTG175` data by running `?ACTG175` (If you become really interested in the data, you can also read an article discussing the trial here: [http://www.nejm.org/doi/full/10.1056/nejm199610103351501#t=article](http://www.nejm.org/doi/full/10.1056/nejm199610103351501#t=article))

```{r, echo = TRUE, eval = FALSE}
# Look at documentation for ACTG175 data (contained in the speff2trial package)
?ACTG175
```

E. First thing's first, take a look at the first few rows of the data by printing the `trial_act` object. It should look like this:

```{r, eval = FALSE, echo = TRUE}
# Print trial_act object
trial_act
```

### Change column names with rename()

1. Lets change some of the column names in `trial_act`. Using `rename()`, change the column name `wtkg` to `weight_kg` (to specify that weight is in kilograms) and `age` to `age_y` (to specify that age is in years). Be sure to assign the result back to `trial_act` to change it!

```{r}
trial_act <- trial_act %>%
  rename(weight_kg = wtkg,
         age_y = age)
```


### Select columns with select()

2. Using the `select()` function, create a new dataframe called `trial_act_demo` that only contains the following demographic information from patients: `pidnum`, `age_y`, `weight_kg`, `race` and `gender`



### Add new columns with mutate()

3. Add the following two new columns to `trial_act`. Do all of these with only *one* call to the mutate() function!
    - `agem` that shows each patient's age in months instead of years (Hint: Just multiply `age_y` by 12!).
    - `weight_lb`: Weight in lbs instead of kilograms. You can do this by multiplying `weight_kg` by 2.2.
    - `cd_change_20`: Change in CD4 T cell count from baseline to 20 weeks. You can do this by taking `cd420 - cd40`
    - `cd_change_960`: Change in CD4 T cell count from baseline to 96 weeks. You can do this by taking `cd496 - cd40`

```{r}
trial_act <- trial_act %>% 
  mutate(agem = age_y * 12
)
```

10. Create a new column `gender_char` that shows gender as a character string. To do this, use a combination of `mutate()` and `case_when`. The original gender data is stored in the `gender` column, where 0 = "female" and1 = "male".
    
```{r}
trial_act <- trial_act %>%
  mutate(
  gender_char = case_when(
    gender == 0 ~ "female",
    gender == 1 ~ "male"
  )
  )
```

11. Create a new column `over50` that is 1 when patients are older than 50, and 0 when they are younger than or equal to 50 (hint: look at the examples above and the use logical comparisons > and <=)

```{r}
trial_act <- trial_act %>%
  mutate(
  over50 = case_when(
    agey > 50 ~ 1,
    agey <= 50 ~ 0
  )
  )
```


12. If you haven't already, put the code for your previous questions in one call to `mutate()`. That is, in one block of code, create `agem`, `weight_lb`, `cd_change_20`, `cd_change_960`, `gender_char` and `over50` using the `mutate()` function only once. Here's how your code shoud look:

```{r, eval = FALSE, echo = TRUE}
trial_act <- trial_act %>%
  mutate(
    agem = XXX,
    weight_lb = XXX,
    cd_change_20 = XXX,
    cd_change_960 = XXX,
    gender_char = case_when(XXX),
    over50 = case_when(XXX)
  )
```

### Arrange rows with arrange()

7. Usingthe `arrange()`function, arrange the `trial_act` data in ascending order of `age_y` (from lowest to highest). After you do, look the data to make sure it worked!

```{r}
trial_act <- trial_act %>% 
 arrange(agey)

trial_act
```

8. Now arrange the data in *descending* order of `age_y` (from highest to lowest). After, look the data to make sure it worked. To arrange data in descending order, just include `desc()` around the variable. E.g.; `data %>% arrrange(desc(height))`


```{r}
trial_act <- trial_act %>% 
 arrange(desc(agey))

trial_act
```

9. You can sort the rows of dataframes with multiple columns by including many arguments to `arrange()`. Now sort the data by arms (`arms`) and then age (`age_y`).

```{r}
trial_act <- trial_act %>% 
 arrange(arms, agey)

trial_act
```


### Filter specific rows with `filter()`

13. Using the `filter()` function, create a new dataframe called `trial_act_m` that only contains data from males (`gender_char == "male"`)

```{r}
trial_act_B <- trial_act %>%
  filter(gender == 1)
```

14. A colleague of yours named Tracy wants a datafame only containing data from females over the age of 40. Create this dataframe with `filter()` and call it `trial_act_Tracy`

```{r}
trial_act_C <- trial_act %>%
  filter(agey > 40 & gender == 0)
```

### Combine dataframes with `left_join()`

15. You can use `left_join()` to combine multiple dataframes. At the following link [https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_data/patient_demo.csv](https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_data/patient_demo.csv) I have some additional (fictional) demographic data about the patients, namely the number of days of exercise they get per week, and their highest level of education. Here's how the first few rows of the data look:

```{r, echo = FALSE, eval = FALSE}
# create trial_act_demo

trial_act_demo <- data.frame(pidnum = ACTG175[,c("pidnum")],
                             exercise = sample(0:7, 
                                               size = nrow(ACTG175), 
                                               replace = TRUE, 
                                              prob = c(.2, .3, .1, .15, .1, .05, .075, .025)),
                             education = sample(c("<HS", "HS", "BA", "MS", "PHD"),
                                                size = nrow(ACTG175), prob = c(.2, .3, .3, .1, .1), replace = TRUE),
                             stringsAsFactors = FALSE)

trial_act_demo <- trial_act_demo[sample(nrow(trial_act_demo)),]

write_csv(trial_act_demo, path = "_sessions/_data/patient_demo.csv")

```

Using `read_csv()` createa new dataframe called `trial_act_demo` that contains these demographic data (Hint: Just enter the URL as the first argument to the function!)


```{r, echo = FALSE, eval = FALSE, message = FALSE}
trial_act_demo <- read_csv("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_data/patient_demo.csv")

trial_act_demo
```

X) Use the `left_join()` function to combine the `trial_act` and `trial_act_demo`, set the `by` argumement to the name of the column that is common in both datasets. This will be the key! Assign the result to `trial_act`. When you are done, look at the `trial_act` dataframe to make sure your code worked!

16. Using your new `trial_act` dataframe, which should contain the exercise data, calculate the mean number of days of exercise that patients reported. Can you do it once using Base-R and once using the pipe %>%?

```{r}
mean(trial_act$exercise)
```

### Calculate grouped statistics with `group_by()` and `summarise()`

*Now it's time to calculate grouped statistics! This is where dplyr really shines!*

17. In this code we'll calculate summary statistics for each of the trial arms. Start with the `trial_act` dataframe. Then, group the data by `arms`. Then, for each arm, calculate the mean participant age as a new column called `age_mean`. Also, using `N = n()`, calculate the number of cases for each group. Assign the result to a new object called `trial_arm`.

```{r, eval = FALSE}
trial_act %>% 
  group_by(arms) %>%
  summarise(
    agey.mean = mean(agey)
  )
```

18. Now adjust your previous code to calculate the standard deviation of age *in addition* to the mean.

```{r}
trial_act %>% 
  group_by(arms) %>%
  summarise(
    agey_mean = mean(agey),
    karnof_median = median(karnof)
  )
```

X) Add code to calculate the median number of days until the first major negative event (`days`) for each arm.

X) Your code so far only creates groups based on `arm`, now adjust the code so it creates groups based on `gender_char` *only* (that is, forget about the trial arm). Keep calculating all of the same summary statistics as you did before. Assign the result to a new dataframe called `trial_gender`

X) Now group the data by *both* `arm` and `gender_char` and calculate the same summary statistics! Assign the result to a new object called `trial_arm_gen`

### Reshaping with gather() and spread()

```{r, echo = FALSE, results = 'asis', eval = TRUE}
trial_dose_wide <- tibble(id = 1:5,
                          low = c(60, 57, 54, 54, 48),
                          high = c(62, 65, 46, 39, 34))

trial_dose_long <- trial_dose_wide %>% 
  gather(level, measure, -id)
```


*Now we'll use the gather() and spread() functions from the tidyr package to change the format of a dataframe*

X. For this section we'll play around with a new small dataframe called `trial_dose_wide` which contains new trial data. Run the following code to create the dataframe called `trial_dose_wide`. When you do, print the dataframe to your console to see how it looks.

```{r, echo = TRUE, eval = TRUE}
trial_dose_wide <- tibble(id = 1:5,
                          low = c(60, 57, 54, 54, 48),
                          high = c(62, 65, 46, 39, 34))
```

Your `trial_dose_wide` dataframe should look like this:

```{r, eval = TRUE, echo = FALSE}
trial_dose_wide
```



```{r, eval = TRUE}
trial_dose_long <- trial_dose_wide %>% 
  gather(level, measure, -id)
```

X. Right now, `trial_dose_wide` is in the 'wide' format, where there are separate columns for each dose (low and high). Our goal is to get the data in the 'long' format. Using the `spread()` function, create a new dataframe called `trial_dose_long` that shows the data in the 'long' format. To do this, use the following template. Set the grouping column to `dose` and the new data column to `reponses`

```{r, echo = TRUE, eval = FALSE}
trial_dose_long <- trial_dose_wide %>% 
  gather(XX,  # New grouping column
         XX,  # New data column
         -id)  # Names of columns to replicate
```

Your final `trial_dose_long` table should look like this:

```{r, echo = FALSE, eval = TRUE}
trial_dose_long
```

X. Using the following template, use the `spread()` function to convert `trial_dose_long` *back the wide format*. Assign the result to a new object called `trial_dose_wide_2`. It should look *exactly* like `trial_dose_wide`!

```{r, echo = TRUE, eval = FALSE}
trial_dose_wide_2 <- trial_dose_long %>% 
  spread(XX,   # old group column
         XX)   # old target column
```


### Challenges


22. Now let's check the major differences between the treatment arms. For each arm, calculate the following:

   - Mean days until a a major negative event (`days`)
   - Mean CD4 T cell count at baseline.
   - Mean CD4 T cell count at 20 weeks.
   - Mean CD4 T cell count at 96 weeks.
   - Mean *change* in CD4 T cell count between baseline and 96 weeks
   - Number of patients (Hint: use `N = n()`)

```{r}
trial_act %>%
  group_by(arms) %>%
  summarise(
    days_mean = mean(days),
    cd4_bl = mean(cd40),
    cd4_20 = mean(cd420),
    cd4_96 = mean(cd496, na.rm = TRUE),
    cd4_change = mean(cd496 - cd40, na.rm = TRUE),
    N = n()
  )
```

23. Repeat the previous analysis, but before you do the grouping and summary statistics, create a new variable called `arms_char` that shows the values of `arms` as characters that reflect what the values actually represent (hint: use `mutate()` and `case_when()`). For example, looking at the help file `?ACTG175`, I can see that the treatment arm of 0 is "zidovudine". I might call this arm `"Z"`. Do this in the all in the same chunk of code.

```{r}
trial_act %>%
  mutate(
    arms_char = case_when(
      arms == 0 ~ "Z",
      arms == 1 ~ "ZD",
      arms == 2 ~ "ZZ",
      arms == 3 ~ "D"
    )
  ) %>%
  group_by(arms_char) %>%
  summarise(
    days_mean = mean(days),
    cd4_bl = mean(cd40),
    cd4_20 = mean(cd420),
    cd4_96 = mean(cd496, na.rm = TRUE),
    cd4_change = mean(cd496 - cd40, na.rm = TRUE)
  )
```

24. Repeat the previous analysis, but only include male patients over the age of 20.

```{r}
trial_act %>%
  filter(karnof == 100 & z30 == 0) %>%
  mutate(
    arms_char = case_when(
      arms == 0 ~ "Z",
      arms == 1 ~ "ZD",
      arms == 2 ~ "ZZ",
      arms == 3 ~ "D"
    )
  ) %>%
  group_by(arms_char) %>%
  summarise(
    days_mean = mean(days),
    cd4_bl = mean(cd40),
    cd4_20 = mean(cd420),
    cd4_96 = mean(cd496, na.rm = TRUE),
    cd4_change = mean(cd496 - cd40, na.rm = TRUE)
  )
```


X) Create a new dataframe called `trial_long` that contains 3 columns: `patientid`, `time` and `CD4` that shows patients' CD4 T cell count at two different time points: at baseline and at 20 weeks. Your final dataframe should look like this:

```{r}
x <- ACTG175 %>%
  select()
```



# Additional reading

- For more details on data wrangling with R, check out the chapter in YaRrr! The Pirate's Guide to R [YaRrr! Chapter Link](https://bookdown.org/ndphillips/YaRrr/advanceddataframe.html)

- Hadley Wickham, the author of dplyr, also has great examples in the dplyr vignette here: [dplyr vignette link](https://cran.r-project.org/web/packageys/dplyr/vignettes/dplyr.html)



